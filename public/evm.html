<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVM Wallet Connection</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <style>
    :root {
      --primary-glow: #00d4ff;
      --secondary-glow: #ff00ff;
      --background: #1a1a2e;
      --card-background: rgba(255, 255, 255, 0.05);
      --text-color: #ffffff;
      --shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: var(--background);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    .holo-card {
      background: var(--card-background);
      border-radius: 15px;
      padding: 2em;
      text-align: center;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 90%;
      width: 400px;
      position: relative;
      z-index: 1;
    }

    .holo-card h2 {
      margin: 0 0 1em;
      font-size: 1.5em;
      background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    button {
      background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow));
      border: none;
      border-radius: 10px;
      padding: 1em 2em;
      color: var(--text-color);
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: var(--shadow);
      margin: 0.5em;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.7);
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }

    p {
      margin: 0.5em 0;
      color: var(--text-color);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 2;
    }

    .modal-content {
      background: var(--card-background);
      border-radius: 15px;
      padding: 2em;
      text-align: center;
      box-shadow: var(--shadow);
      max-width: 90%;
      width: 300px;
    }

    .modal-content p {
      margin: 0 0 1em;
    }

    .background-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at 50% 50%, rgba(0, 212, 255, 0.1), transparent 70%);
    }
  </style>
</head>
<body>
  <div class="background-effects"></div>
  <div class="holo-card">
    <h2>Connect Your EVM Wallet</h2>
    <button id="connectMetaMask">Connect MetaMask</button>
    <button id="connectWalletConnect">Connect WalletConnect</button>
    <p id="status">Please select a wallet to connect.</p>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <p id="modalMessage">Connecting...</p>
      <button id="modalClose">Close</button>
    </div>
  </div>

  <script>
    const TelegramWebApp = window.Telegram?.WebApp;
    let provider, signer, walletAddress;

    // TWA initialization
    if (TelegramWebApp) {
      TelegramWebApp.ready();
      TelegramWebApp.expand();
      TelegramWebApp.MainButton.setParams({
        text: 'Return to GigiP2Bot',
        color: '#00d4ff',
        text_color: '#ffffff'
      });
      TelegramWebApp.MainButton.show();
      TelegramWebApp.MainButton.onClick(() => TelegramWebApp.close());

      // Add "Open in Browser" prompt
      const message = document.createElement('p');
      message.textContent = 'For better wallet connection experience, consider opening this page in your browser.';
      message.style.color = 'white';
      message.style.marginBottom = '10px';
      const button = document.createElement('button');
      button.textContent = 'Open in Browser';
      button.style.background = 'linear-gradient(45deg, var(--primary-glow), var(--secondary-glow))';
      button.style.border = 'none';
      button.style.borderRadius = '10px';
      button.style.padding = '1em 2em';
      button.style.color = '#ffffff';
      button.style.fontSize = '1em';
      button.style.fontWeight = '500';
      button.style.cursor = 'pointer';
      button.style.boxShadow = '0 0 20px rgba(0, 212, 255, 0.5)';
      button.onclick = () => TelegramWebApp.openLink(window.location.href);
      const holoCard = document.querySelector('.holo-card');
      holoCard.insertBefore(button, holoCard.firstChild);
      holoCard.insertBefore(message, holoCard.firstChild);
    }

    // Modal handling
    const modal = document.getElementById('modal');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');
    const status = document.getElementById('status');

    function showModal(message) {
      modalMessage.textContent = message;
      modal.style.display = 'flex';
      if (TelegramWebApp) TelegramWebApp.HapticFeedback.impactOccurred('light');
    }

    modalClose.onclick = () => {
      modal.style.display = 'none';
      if (TelegramWebApp) TelegramWebApp.HapticFeedback.impactOccurred('medium');
    };

    // URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    const amount = parseFloat(urlParams.get('amount')) || 0;
    const token = urlParams.get('token');
    const toAddress = urlParams.get('to');
    const tid = urlParams.get('tid');

    // Validate required parameters
    if (!userId) {
      showModal('Error: User ID is missing. Please try again.');
      status.textContent = 'Invalid link. Missing user ID.';
      return;
    }

    // Connect MetaMask
    document.getElementById('connectMetaMask').onclick = async () => {
      if (!window.ethereum) {
        showModal('MetaMask not detected! Please install MetaMask or open in browser.');
        return;
      }
      try {
        showModal('Connecting to MetaMask...');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        status.textContent = `Connected: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
        modal.style.display = 'none';
        if (TelegramWebApp) TelegramWebApp.HapticFeedback.impactOccurred('medium');
        if (amount && toAddress && token) {
          await signTransaction();
        } else {
          await confirmConnection();
        }
      } catch (error) {
        showModal(`Error: ${error.message}`);
        status.textContent = 'Connection failed. Try again.';
      }
    };

    // Connect WalletConnect
    document.getElementById('connectWalletConnect').onclick = async () => {
      try {
        showModal('Connecting to WalletConnect...');
        const wcProvider = new window.WalletConnectProvider({
          infuraId: '753520ebaf074efb8e464667dade5337', // Your Infura ID
        });
        await wcProvider.enable();
        provider = new ethers.providers.Web3Provider(wcProvider);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();
        status.textContent = `Connected: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`;
        modal.style.display = 'none';
        if (TelegramWebApp) TelegramWebApp.HapticFeedback.impactOccurred('medium');
        if (amount && toAddress && token) {
          await signTransaction();
        } else {
          await confirmConnection();
        }
      } catch (error) {
        showModal(`Error: ${error.message}`);
        status.textContent = 'Connection failed. Try again.';
      }
    };

    // Confirm wallet connection
    async function confirmConnection() {
      try {
        showModal('Confirming wallet connection...');
        const response = await fetch('https://your-webhook-url/evm-webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            txHash: '0xmockhash' + Date.now(), // Mock hash for connection confirmation
            wallet: walletAddress,
            tid
          })
        });

        if (response.ok) {
          showModal('Wallet connected successfully! ðŸš€');
          status.textContent = 'Wallet connection confirmed!';
        } else {
          showModal('Failed to confirm wallet connection. Please try again.');
          status.textContent = 'Confirmation failed.';
        }
      } catch (error) {
        showModal(`Error: ${error.message}`);
        status.textContent = 'Confirmation failed. Try again.';
      }
    }

    // Sign transaction
    async function signTransaction() {
      if (!provider || !signer) {
        showModal('Wallet not connected!');
        return;
      }
      try {
        showModal(`Sending ${amount} ${token}...`);
        const nonce = await provider.getTransactionCount(walletAddress, 'latest');
        const gasPrice = await provider.getGasPrice();
        const gasLimit = ethers.utils.hexlify(21000);

        const tx = {
          to: toAddress,
          value: ethers.utils.parseEther(amount.toString()),
          gasPrice,
          gasLimit,
          nonce,
          chainId: 1, // Mainnet; adjust for testnets
        };

        const signedTx = await signer.sendTransaction(tx);
        const receipt = await signedTx.wait();

        // Send to webhook
        const response = await fetch('https://your-webhook-url/evm-webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            txHash: receipt.transactionHash,
            wallet: walletAddress,
            tid
          })
        });

        if (response.ok) {
          showModal('Transaction successful! ðŸš€');
          status.textContent = 'Transaction completed!';
        } else {
          showModal('Failed to confirm transaction. Please try again.');
          status.textContent = 'Transaction failed.';
        }
      } catch (error) {
        showModal(`Error: ${error.message}`);
        status.textContent = 'Transaction failed. Try again.';
      }
    }
  </script>
</body>
</html>
