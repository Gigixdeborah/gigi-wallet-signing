<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connect EVM Wallet | Gigi Labs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(ellipse at top, #0f0c29, #302b63, #24243e);
      color: white; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    h1 { font-size: 24px; color: #00e0ff; margin-bottom: 20px; text-shadow: 0 0 10px #00e0ff; }
    button {
      padding: 14px 30px; font-size: 16px;
      margin: 10px; border: none; border-radius: 10px;
      cursor: pointer; transition: 0.3s;
    }
    #connectBtn { background: #00e0ff; color: #000; }
    #signBtn { background: #00ff95; color: #000; display: none; }
    #disconnectBtn { background: #ff4444; color: #fff; display: none; }
    footer { position: absolute; bottom: 10px; font-size: 14px; color: #aaa; }
  </style>
</head>
<body>

<script>
  if (navigator.userAgent.toLowerCase().includes("telegram")) {
    const url = encodeURIComponent(window.location.href);
    const open = confirm("Telegram browser blocks wallet extensions.\nOpen in Chrome?");
    if (open) window.location.href = `https://t.me/share/url?url=${url}`;
  }
</script>

<h1>Connect Your EVM Wallet</h1>
<button id="connectBtn">Connect Wallet</button>
<button id="signBtn">Sign Transaction</button>
<button id="disconnectBtn">Disconnect</button>
<footer>✨ Powered by Gigi Labs</footer>

<script>
  const user_id = new URLSearchParams(location.search).get("user_id");
  const amount = new URLSearchParams(location.search).get("amount");
  const to = new URLSearchParams(location.search).get("to");

  let web3Modal, provider, web3, selectedAccount;

  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: {
        infuraId: "1a81cf7a582e4ebfb768bce6a7ec1e55"
      }
    }
  };

  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions
  });

  async function connectWallet() {
    try {
      provider = await web3Modal.connect();
      web3 = new Web3(provider);
      const accounts = await web3.eth.getAccounts();
      selectedAccount = accounts[0];
      document.getElementById("signBtn").style.display = "inline-block";
      document.getElementById("disconnectBtn").style.display = "inline-block";
    } catch (err) {
      alert("❌ Connection failed.");
    }
  }

  async function disconnectWallet() {
    if (provider && provider.close) await provider.close();
    await web3Modal.clearCachedProvider();
    provider = null;
    selectedAccount = null;
    document.getElementById("signBtn").style.display = "none";
    document.getElementById("disconnectBtn").style.display = "none";
  }

  async function signTransaction() {
    if (!selectedAccount) return alert("Wallet not connected.");

    const valueInWei = web3.utils.toWei(amount, "ether");
    const tx = {
      from: selectedAccount,
      to: to,
      value: valueInWei
    };

    try {
      const txHash = await web3.eth.sendTransaction(tx);

      await fetch("http://34.203.188.151:5000/evm-webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id,
          wallet: selectedAccount,
          to,
          amount,
          tx_type: "buy",
          token: "ETH",
          signed_tx: txHash.transactionHash
        })
      });

      new Audio("https://assets.mixkit.co/sfx/preview/mixkit-game-bonus-reached-2065.mp3").play();
      alert("✅ Transaction Sent!\n" + txHash.transactionHash);
    } catch (err) {
      alert("❌ Transaction failed or rejected.");
    }
  }

  document.getElementById("connectBtn").onclick = connectWallet;
  document.getElementById("disconnectBtn").onclick = disconnectWallet;
  document.getElementById("signBtn").onclick = signTransaction;
</script>

</body>
</html>
