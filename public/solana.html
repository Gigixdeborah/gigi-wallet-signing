<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Wallet Sign | Gigi Labs</title>
  <style>
    body {
      background: #000;
      margin: 0;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }
    button {
      padding: 14px 28px;
      font-size: 16px;
      background: #00ffaa;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #00ddaa;
    }
    .footer {
      position: absolute;
      bottom: 15px;
      color: #aaa;
    }
    .footer span {
      color: #fff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Solana Wallet Connect</h1>
  <button onclick="connectAndSign()">Connect Wallet & Sign</button>
  <div class="footer">✨ Powered by <span>Gigi Labs</span></div>

  <script type="module">
    import {
      Connection,
      Transaction,
      SystemProgram,
      PublicKey,
      clusterApiUrl
    } from "https://cdn.skypack.dev/@solana/web3.js";

    async function connectAndSign() {
      const params = new URLSearchParams(window.location.search);
      const toAddress = params.get("to");
      const amount = parseInt(params.get("amount") || "0");
      const user_id = params.get("user_id") || "unknown";

      if (!toAddress || amount <= 0) {
        alert("Missing or invalid 'to' or 'amount' in URL.");
        return;
      }

      try {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) {
          alert("Phantom wallet not found.");
          return;
        }

        const resp = await provider.connect();
        const publicKey = resp.publicKey;
        const toPubkey = new PublicKey(toAddress);
        const connection = new Connection(clusterApiUrl("mainnet-beta"), "confirmed");

        const { blockhash } = await connection.getLatestBlockhash();

        const transaction = new Transaction({
          recentBlockhash: blockhash,
          feePayer: publicKey,
        });

        transaction.add(SystemProgram.transfer({
          fromPubkey: publicKey,
          toPubkey: toPubkey,
          lamports: amount
        }));

        const signed = await provider.signTransaction(transaction);
        const signedTx = signed.serialize().toString('base64');

        await fetch("/solana-webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id,
            wallet: publicKey.toString(),
            to: toAddress,
            token: "SOL",
            amount,
            signed_tx: signedTx
          })
        });

        alert("✅ Transaction signed and sent to webhook!");
      } catch (err) {
        console.error(err);
        alert("❌ Error occurred. Check console.");
      }
    }
  </script>
</body>
</html>
