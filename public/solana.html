// universal-solana-connect.jsx

import React, { useMemo, useEffect, useState, useRef } from 'react';
import {
  ConnectionProvider,
  WalletProvider,
} from '@solana/wallet-adapter-react';
import {
  WalletModalProvider,
  WalletMultiButton,
} from '@solana/wallet-adapter-react-ui';
import {
  PhantomWalletAdapter,
  SolflareWalletAdapter,
  BackpackWalletAdapter,
} from '@solana/wallet-adapter-wallets';
import { clusterApiUrl, Connection, PublicKey, SystemProgram, Transaction } from '@solana/web3.js';
import './App.css';
require('@solana/wallet-adapter-react-ui/styles.css');

const App = () => {
  const network = 'mainnet-beta';
  const endpoint = useMemo(() => clusterApiUrl(network), [network]);

  const wallets = useMemo(
    () => [new PhantomWalletAdapter(), new SolflareWalletAdapter(), new BackpackWalletAdapter()],
    []
  );

  const [publicKey, setPublicKey] = useState(null);
  const [wallet, setWallet] = useState(null);
  const [amount, setAmount] = useState('');
  const [toAddress, setToAddress] = useState('');

  const canvasRef = useRef(null);
  const nodes = useRef([]);
  const animationFrameId = useRef(null);

  useEffect(() => {
    if (wallet && wallet.publicKey) setPublicKey(wallet.publicKey.toBase58());
  }, [wallet]);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function createNode(x = Math.random() * canvas.width, y = Math.random() * canvas.height) {
      return {
        x,
        y,
        vx: (Math.random() - 0.5) * 1.2,
        vy: (Math.random() - 0.5) * 1.2,
        radius: 2 + Math.random(),
      };
    }

    function initNodes() {
      nodes.current = [];
      for (let i = 0; i < 60; i++) {
        nodes.current.push(createNode());
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      nodes.current.forEach((n, i) => {
        n.x += n.vx;
        n.y += n.vy;
        if (n.x < 0 || n.x > canvas.width) n.vx *= -1;
        if (n.y < 0 || n.y > canvas.height) n.vy *= -1;

        ctx.beginPath();
        ctx.arc(n.x, n.y, n.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#00e0ff';
        ctx.shadowBlur = 8;
        ctx.shadowColor = '#00ffff';
        ctx.fill();

        for (let j = i + 1; j < nodes.current.length; j++) {
          const n2 = nodes.current[j];
          const dx = n.x - n2.x;
          const dy = n.y - n2.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 100) {
            ctx.beginPath();
            ctx.moveTo(n.x, n.y);
            ctx.lineTo(n2.x, n2.y);
            ctx.strokeStyle = 'rgba(0,255,255,0.07)';
            ctx.stroke();
          }
        }
      });
      animationFrameId.current = requestAnimationFrame(animate);
    }

    function handlePointerMove(e) {
      const rect = canvas.getBoundingClientRect();
      nodes.current.push(createNode(e.clientX - rect.left, e.clientY - rect.top));
      if (nodes.current.length > 100) nodes.current.shift();
    }

    resizeCanvas();
    initNodes();
    animate();
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('pointermove', handlePointerMove);

    return () => {
      cancelAnimationFrame(animationFrameId.current);
      window.removeEventListener('resize', resizeCanvas);
      window.removeEventListener('pointermove', handlePointerMove);
    };
  }, []);

  const sendTransaction = async () => {
    if (!wallet || !wallet.publicKey) return alert('Connect a wallet');
    if (!amount || !toAddress) return alert('Enter amount and recipient');

    const connection = new Connection(endpoint, 'confirmed');
    const recipient = new PublicKey(toAddress);
    const lamports = Math.floor(parseFloat(amount) * 1e9);

    const transaction = new Transaction().add(
      SystemProgram.transfer({
        fromPubkey: wallet.publicKey,
        toPubkey: recipient,
        lamports,
      })
    );

    transaction.feePayer = wallet.publicKey;
    const { blockhash } = await connection.getLatestBlockhash();
    transaction.recentBlockhash = blockhash;

    try {
      const signed = await wallet.signTransaction(transaction);
      const sig = await connection.sendRawTransaction(signed.serialize());
      await connection.confirmTransaction(sig);

      await fetch('http://34.203.188.151:5000/solana-webhook', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: '123', amount, to: toAddress, signature: sig })
      });

      alert(`Transaction sent! Signature: ${sig}`);
    } catch (err) {
      alert('Transaction failed or cancelled');
    }
  };

  return (
    <ConnectionProvider endpoint={endpoint}>
      <WalletProvider wallets={wallets} autoConnect>
        <WalletModalProvider>
          <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full z-[-1]" />
          <div className="min-h-screen bg-transparent text-white flex flex-col items-center justify-center relative">
            <h1 className="text-2xl font-semibold mb-4 z-10">Gigi Solana Wallet Connect</h1>
            <WalletMultiButton className="mb-6 z-10" />
            <div className="flex flex-col items-center gap-2 z-10">
              <input
                className="p-2 rounded bg-white/10 border border-purple-500 w-64"
                type="text"
                placeholder="Recipient Address"
                value={toAddress}
                onChange={(e) => setToAddress(e.target.value)}
              />
              <input
                className="p-2 rounded bg-white/10 border border-purple-500 w-64"
                type="number"
                placeholder="Amount (SOL)"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
              />
              <button
                onClick={sendTransaction}
                className="bg-purple-500 px-6 py-2 mt-2 rounded shadow hover:bg-purple-600 transition"
              >
                Sign & Send
              </button>
            </div>
            <footer className="mt-8 text-sm opacity-60 z-10">Powered by Gigi Labs âœ¨</footer>
          </div>
        </WalletModalProvider>
      </WalletProvider>
    </ConnectionProvider>
  );
};

export default App;
