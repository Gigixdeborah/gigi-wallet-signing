<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Solana Wallet Connect & Sign</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-wallets@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-react-ui@latest"></script>
    <style>
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîó Connect & Sign on Solana</h1>
    <button id="connect">Connect Wallet</button>
    <button id="sign" disabled>Sign Transaction</button>
    <div id="status">Status: Waiting for connection...</div>

    <script type="module">
        import {
            PhantomWalletAdapter,
            SolflareWalletAdapter,
            TorusWalletAdapter,
            LedgerWalletAdapter
        } from "https://cdn.skypack.dev/@solana/wallet-adapter-wallets";

        const connectBtn = document.getElementById('connect');
        const signBtn = document.getElementById('sign');
        const statusEl = document.getElementById('status');

        let wallet = null;
        let publicKey = null;

        const wallets = [
            new PhantomWalletAdapter(),
            new SolflareWalletAdapter(),
            new TorusWalletAdapter(),
            new LedgerWalletAdapter()
        ];

        function updateStatus(msg) {
            statusEl.textContent = msg;
        }

        connectBtn.onclick = async () => {
            try {
                for (const w of wallets) {
                    if (w.readyState === 'Installed') {
                        wallet = w;
                        break;
                    }
                }
                if (!wallet) {
                    updateStatus('‚ùå No installed wallet found. Install Phantom or Solflare.');
                    return;
                }
                await wallet.connect();
                publicKey = wallet.publicKey.toBase58();
                updateStatus(`‚úÖ Connected: ${publicKey}`);
                signBtn.disabled = false;
            } catch (err) {
                updateStatus(`‚ùå Connection failed: ${err.message}`);
            }
        };

        signBtn.onclick = async () => {
            try {
                const message = new TextEncoder().encode('Sign this transaction for Gigi!');
                const signed = await wallet.signMessage(message, 'utf8');
                updateStatus(`‚úÖ Signed!\nSignature: ${Buffer.from(signed.signature).toString('base64')}`);

                const payload = {
                    user_id: new URLSearchParams(window.location.search).get('user_id'),
                    address: publicKey,
                    signature: Buffer.from(signed.signature).toString('base64')
                };

                await fetch('/solana-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                updateStatus(prev => prev + '\nüöÄ Signature sent to server!');
            } catch (err) {
                updateStatus(`‚ùå Signing failed: ${err.message}`);
            }
        };
    </script>
</body>
</html>
